M = $M
calc_distortion = $calc_dist
sample_size = $sample_size
centroids = $centroids
dataset = $dataset
pq = $pq
sep = $sep


v = read("data/distortion/" + dataset + ".hdf5", rows=100000, cols=128, format="hdf5")

if(sample_size < nrow(v)) {
  v = v[1:sample_size,]
}
else {
  sample_size = nrow(v)
}

if(pq) {
  [codebook, codes] = quantizeByCluster(v, M, centroids / M, 1, 1000, 1e-8, (sample_size/(centroids/M)), sep, 2)
}
else {
  [codebook, codes] = kmeans(v, centroids, 1, 1000, 1e-8, FALSE, (sample_size/centroids), 2)
}

cols = 128
rows=sample_size

result = matrix(0, rows=rows, cols=cols)

#todo: maybe integer division + throw error
subv = ncol(v) / M

#construct vectors from codes
if(pq) {
  if(calc_distortion) {
  parfor (i in 1:nrow(codes), check=0) {
    parfor (j in 1:ncol(codes), check=0) {
      result[i, 1 + (j-1)* subv: j * subv] = codebook[as.scalar(codes[i, j])]
    }
  }
}

}
else {
  parfor(i in 1:nrow(codes), check=0) {
    result[i,] = codebook[as.scalar(codes[i])]
  }
}

distortion = colSums(rowSums((v - result)^2)) / rows

if(pq) {
out_file = "output/distortion/PQ " + dataset + " " + M + " " + centroids + " " + sample_size + " " + sep
}
else {
out_file = "output/distortion/K-Means " + dataset + " " + M + " " + centroids + " " + sample_size + " " + sep
}
#existing = read(out_file, format="csv")
#distortion = rbind(existing, distortion)
write(distortion, out_file, format="csv", header=FALSE, sep=";")



